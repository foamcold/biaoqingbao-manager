<!doctype html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡¨æƒ…åŒ…é¢„è§ˆ - {{ category_name }}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <style>
        .image-wall {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); /* Reverted to responsive grid */
            gap: 1.5rem; /* Increased gap */
        }
        .image-card {
            border: 1px solid #dee2e6;
            border-radius: .25rem;
            padding: 0.75rem; /* Increased padding */
            text-align: center;
            display: flex;
            flex-direction: column; /* Arrange items vertically */
            justify-content: space-between; /* Push actions to bottom */
            position: relative; /* Needed for potential absolute positioning if required */
            overflow: hidden; /* Hide actions overflowing initially if using height=0 */
        }
        .image-card img {
            max-width: 100%;
            height: auto;
            /* max-height: 160px; */ /* Old height */
            max-height: 220px; /* Increased preview height */
            object-fit: contain;
            margin-bottom: 0.75rem; /* Increased margin */
            cursor: pointer; /* Indicate clickable for maybe a larger preview later */
            transition: transform 0.2s ease-in-out; /* Add slight zoom effect on hover */
        }
        .image-card:hover img {
            transform: scale(1.03); /* Slight zoom */
        }
        .image-card .filename {
            font-size: 0.85rem; /* Slightly larger */
            color: #6c757d;
            margin-bottom: 0.75rem;
            word-break: break-all;
            flex-grow: 1; /* Allow filename area to grow */
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
            opacity: 1;
            visibility: visible;
            /* Ensure it takes up space */
            min-height: 2.5em; /* Adjust as needed based on font size and line height */
            display: flex; /* Use flex to center vertically if needed */
            align-items: center;
            justify-content: center;
        }
        .image-card .actions {
            display: flex; /* Keep horizontal layout */
            flex-wrap: nowrap; /* Prevent wrapping */
            gap: 0.5rem; /* Increased gap between buttons */
            justify-content: center;
            align-items: center; /* Align items vertically */
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
            opacity: 0;
            visibility: hidden;
            position: absolute; /* Position over the filename area */
            bottom: 0.75rem; /* Align with original filename bottom padding */
            left: 0;
            right: 0;
            /* Take up the space filename used */
            min-height: 2.5em; /* Match filename min-height */
            display: flex; /* Keep using flex */
            align-items: center; /* Center buttons vertically */
            /* Add a subtle background? Optional */
            /* background-color: rgba(255, 255, 255, 0.9); */
            /* border-top: 1px solid #eee; */ 
            padding: 0.2rem 0.5rem; /* Adjust padding for buttons */
        }
         /* Ensure buttons have consistent size */
         .image-card .actions .btn {
             padding: 0.25rem 0.5rem; 
             font-size: 0.9rem;
         }
        .modal-lg-fullscreen {
            max-width: 95vw; /* Allow large modal */
            max-height: 90vh;
            margin: 1rem auto;
        }
        #imagePreviewModal .modal-body {
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden; /* Prevent scrollbars on body */
        }
         #imagePreviewModal .modal-body img {
             max-width: 100%;
             max-height: 80vh; /* Limit image height within modal */
             object-fit: contain;
         }
        #imagePreviewModal .modal-footer {
            justify-content: space-between; /* Space out filename and actions */
        }
        #imagePreviewModal .filename-preview {
             font-size: 0.9rem;
             color: #6c757d;
             overflow: hidden;
             text-overflow: ellipsis;
             white-space: nowrap;
             max-width: 50%; /* Limit filename width */
        }
        /* Prevent text selection on modal filename */
        #modalPreviewFilename {
            user-select: none; /* Standard */
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* IE/Edge */
        }
        .modal-nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            font-size: 2rem;
            background-color: rgba(0,0,0,0.3);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            opacity: 0.7;
            transition: opacity 0.2s;
            z-index: 1070; /* Increased z-index */
        }
        .modal-nav-btn:hover {
            opacity: 1;
            color: white;
        }
        .modal-nav-prev { left: 10px; }
        .modal-nav-next { right: 10px; }
        /* Show actions and hide filename on card hover */
        .image-card:hover .filename {
            opacity: 0;
            visibility: hidden;
        }
        .image-card:hover .actions {
            opacity: 1;
            visibility: visible;
        }

        /* Batch Mode Styles */
        .batch-controls {
            display: none; /* Hidden by default */
        }
        /* When batch mode is active */
        body.batch-mode .batch-controls {
            display: inline-flex; /* Display inline with the toggle button */
            align-items: center; /* Vertically align items inside */
            vertical-align: middle; /* Align the container itself with the toggle button */
            margin-left: 0.5rem; /* Add space between toggle and batch actions */
        }
        /* Style selected cards */
        body.batch-mode .image-card.is-selected {
            border-color: #0d6efd; /* Bootstrap primary blue */
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }
        /* Dim image when selected? Optional */
        /* body.batch-mode-active .image-card.is-selected img {
            opacity: 0.7;
        } */
        /* Override hover actions when in batch mode to allow selection */
        body.batch-mode .image-card:hover .filename {
             opacity: 1;
             visibility: visible;
        }
        body.batch-mode .image-card:hover .actions {
            opacity: 0;
            visibility: hidden;
        }
        body.batch-mode .image-card .actions { /* Also hide actions normally in batch mode */
             display: none;
         }

        /* Batch mode styles */
        body.batch-mode .image-card .batch-checkbox {
            display: block;
        }
        body.batch-mode .image-card .card-img-overlay {
            cursor: pointer; /* Indicate clickable area */
            background-color: rgba(0, 0, 0, 0.1); /* Slight overlay */
        }
        body.batch-mode .image-card .card-body {
            opacity: 1; 
            visibility: visible;
        }
        body.batch-mode .image-card:hover .card-body {
            opacity: 1;
            visibility: visible;
        }
         body.batch-mode .image-card .card-actions {
            display: none; /* Hide individual actions */
        }

        .batch-actions {
            display: none; /* Hidden by default */
            margin-bottom: 1rem;
        }
        body.batch-mode .batch-actions {
            /* display: block; Show in batch mode */
            display: inline-flex; /* Display inline with the toggle button */
            align-items: center; /* Vertically align items inside */
            vertical-align: middle; /* Align the container itself with the toggle button */
            margin-left: 0.5rem; /* Add space between toggle and batch actions */
        }

        /* Default visibility for control groups */
        .batch-mode-controls {
            display: none;
        }
        .normal-mode-controls {
            display: flex;
            align-items: center;
        }

        /* Control group visibility in batch mode */
        body.batch-mode .batch-mode-controls {
            display: flex !important; /* Added !important for debugging */
            align-items: center;
        }
        body.batch-mode .normal-mode-controls {
            display: flex;
            align-items: center;
        }

        /* Prevent filename selection on card in batch mode */
        body.batch-mode .image-card .filename {
            user-select: none; /* Standard */
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* IE/Edge */
        }

        /* Default visibility for category view control groups */
        .view-batch-controls {
            display: none;
            align-items: center;
            gap: 0.5rem; 
        }
        .view-normal-controls {
            display: inline-flex; /* Or flex if it's the only thing */
            align-items: center;
        }

        /* Visibility in batch mode */
        body.batch-mode .view-batch-controls {
            display: inline-flex !important; /* Use important if needed */
        }
        body.batch-mode .view-normal-controls {
            display: none !important; /* Use important if needed */
        }

    </style>
</head>
<body>
<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <!-- Category Dropdown with Filter -->
        <div class="dropdown">
            <button class="btn btn-lg btn-outline-primary dropdown-toggle" type="button" id="categoryDropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                åˆ†ç±»: {{ category_name }}
            </button>
            <ul class="dropdown-menu" aria-labelledby="categoryDropdownMenuButton" id="categoryDropdownMenu">
                <!-- Filter Input -->
                <li><input type="text" class="form-control form-control-sm mx-2 mb-2 w-auto" id="categoryFilterInput" placeholder="è¿‡æ»¤åˆ†ç±»..."></li>
                <!-- Dropdown Items -->
                {% if all_categories %}
                    {% for cat in all_categories %}
                        <li><a class="dropdown-item {% if cat == category_name %}active{% endif %}" href="{{ url_for('view_category', category_name=cat) }}">{{ cat }}</a></li>
                    {% endfor %}
                {% else %}
                     <li><span class="dropdown-item disabled">æ— å…¶ä»–åˆ†ç±»</span></li>
                {% endif %}
            </ul>
        </div>
        <!-- End Category Dropdown -->

        <!-- Right side Action Buttons -->
        <div class="action-buttons-container">
            <a href="{{ url_for('admin') }}" class="btn btn-secondary btn-lg me-2">è¿”å›</a> <!-- Larger button, Logout removed -->
        </div>
    </div>

    <hr class="my-3"> <!-- Added horizontal line -->

    <!-- Per Page Selector and Batch Controls Row -->
    <div class="d-flex justify-content-between align-items-center mb-3"> <!-- Left/Right alignment -->
        <!-- Left: Pagination Info -->
         <div class="pagination-info">
            {% if total_items > 0 %}
                {% set start_item = (page - 1) * per_page + 1 %}
                {% set end_item = page * per_page if page * per_page < total_items else total_items %}
                æ˜¾ç¤ºç¬¬ {{ start_item }} - {{ end_item }} é¡¹ï¼Œå…± {{ total_items }} é¡¹
            {% elif items %}
                 æ˜¾ç¤º {{ items|length }} é¡¹
            {% endif %}
        </div>

        <!-- Right: Batch Toggle, Batch Actions, Per Page -->
        <div class="d-flex align-items-center gap-3">
            <!-- Normal Mode Control (just the toggle button) -->
            <div class="view-normal-controls">
               <button type="button" class="btn btn-info btn-sm" id="toggleBatchMode">æ‰¹é‡ç®¡ç†</button>
            </div>
            <!-- Batch Mode Controls -->
            <div class="view-batch-controls">
                 <!-- Order Changed: Select All First -->
                <div class="form-check form-check-inline align-middle me-2">
                   <input class="form-check-input" type="checkbox" id="selectAllCheckbox">
                   <label class="form-check-label" for="selectAllCheckbox">å…¨é€‰/å–æ¶ˆ</label>
               </div>
                <button class="btn btn-danger btn-sm" id="batchDeleteButton" data-bs-toggle="modal" data-bs-target="#batchDeleteConfirmModal">æ‰¹é‡åˆ é™¤</button>
                <!-- Exit button will be moved here by JS -->
            </div>

            <!-- Per Page Selector -->
            <div>
                <label for="perPageSelect" class="form-label me-2">æ¯é¡µæ˜¾ç¤º:</label>
                <select class="form-select form-select-sm d-inline-block w-auto" id="perPageSelect">
                    {% for val in allowed_per_page_values %}
                        <option value="{{ val }}" {% if val == per_page %}selected{% endif %}>{{ val }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <!-- Flash Messages -->
    <div id="flash-message-container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    {% if items %}
        <div class="image-wall mb-4">
            {% for item in items %}
                <div class="image-card"
                     data-item-id="{{ item.id }}"
                     data-item-type="{{ item.type }}"
                     data-item-name="{{ item.name }}" {# For display and some JS operations #}
                     data-view-url="{{ item.view_url }}" {# For preview #}
                     >
                    {% if item.type == 'local' %}
                        <img src="{{ item.view_url }}"
                             alt="{{ item.name }}"
                             loading="lazy"
                             class="img-thumbnail preview-trigger" {# preview-trigger for local images only #}
                             data-index="{{ loop.index0 }}" {# Still useful for local image array indexing #}
                             onerror="this.style.display='none'; this.parentElement.innerHTML += '<div class=\'text-danger small\'>æœ¬åœ°å›¾ç‰‡åŠ è½½å¤±è´¥</div>';"
                             >
                        <span class="filename" title="{{ item.name }}">{{ item.name }}</span>
                        <div class="actions">
                            <button type="button" class="btn btn-sm btn-outline-warning rename-btn" title="é‡å‘½å" data-bs-toggle="modal" data-bs-target="#renameModal" data-category-name="{{ category_name }}" data-old-filename="{{ item.name }}">âœï¸</button>
                            <button type="button" class="btn btn-sm btn-outline-danger delete-btn" title="åˆ é™¤" data-category-name="{{ category_name }}" data-filename="{{ item.name }}">ğŸ—‘ï¸</button>
                        </div>
                    {% elif item.type == 'external' %}
                        <a href="{{ item.view_url }}" target="_blank" rel="noopener noreferrer" title="åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€å¤–éƒ¨é“¾æ¥: {{ item.name }}">
                            <img src="{{ item.view_url }}"
                                 alt="å¤–éƒ¨é“¾æ¥: {{ item.name }}"
                                 loading="lazy"
                                 class="img-thumbnail"
                                 referrerpolicy="no-referrer" {# Attempt to prevent sending referrer #}
                                 onerror="this.style.display='none'; if (!this.parentElement.querySelector('.external-error-message')) { this.parentElement.insertAdjacentHTML('beforeend', '<div class=\'text-danger small external-error-message\'>å¤–éƒ¨å›¾ç‰‡æ— æ³•åŠ è½½<br><a href=\'{{ item.view_url | e }}\' target=\'_blank\' rel=\'noopener noreferrer\' class=\'btn btn-sm btn-link p-0\'>å°è¯•æ‰“å¼€åŸå§‹é“¾æ¥</a></div>'); } this.onerror=null;"
                                 style="object-fit: contain; cursor: pointer;"
                                 >
                        </a>
                        <span class="filename" title="{{ item.name }}">{{ item.name | truncate(60) }}</span> {# Truncate long URLs #}
                        <div class="actions">
                            <button type="button" class="btn btn-sm btn-outline-info edit-external-link-btn" title="ç¼–è¾‘å¤–é“¾" data-bs-toggle="modal" data-bs-target="#editExternalLinkModal" data-link-id="{{ item.id }}" data-link-url="{{ item.view_url }}">âœï¸</button>
                            <form action="{{ url_for('delete_external_link', category_name=category_name, link_id=item.id) }}" method="post" class="d-inline" onsubmit="return confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¤–éƒ¨é“¾æ¥å—ï¼Ÿ {{ item.view_url | e }}');">
                                <button type="submit" class="btn btn-sm btn-outline-danger" title="åˆ é™¤å¤–é“¾">ğŸ—‘ï¸</button>
                            </form>
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="alert alert-info">è¿™ä¸ªåˆ†ç±»ä¸‹è¿˜æ²¡æœ‰ä»»ä½•é¡¹ç›®ã€‚</div>
    {% endif %}

    <!-- Pagination Navigation -->
    {% if total_pages > 1 %}
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            <!-- Previous Page Link -->
            <li class="page-item {% if page <= 1 %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('view_category', category_name=category_name, page=page-1, per_page=per_page) }}" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>

            <!-- Page Number Links (Simplified for now, can add ellipsis later if needed) -->
            {% for page_num in range(1, total_pages + 1) %}
                <li class="page-item {% if page_num == page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('view_category', category_name=category_name, page=page_num, per_page=per_page) }}">{{ page_num }}</a>
                </li>
            {% endfor %}

            <!-- Next Page Link -->
            <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('view_category', category_name=category_name, page=page+1, per_page=per_page) }}" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
        </ul>
    </nav>
    {% endif %}
    <!-- End Pagination Navigation -->

</div>

<!-- Rename Modal Structure -->
<div class="modal fade" id="renameModal" tabindex="-1" aria-labelledby="renameModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="renameModalLabel">é‡å‘½åæ–‡ä»¶</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>å½“å‰æ–‡ä»¶å: <strong id="renameModalOldFilename"></strong></p>
        <form id="renameModalForm"> 
            <!-- Hidden fields to store context -->
            <input type="hidden" id="renameModalCategoryName" name="category_name_modal">
            <input type="hidden" id="renameModalOldFilenameHidden" name="old_filename_modal">
            
            <div class="mb-3">
                <label for="renameModalNewFilename" class="form-label">æ–°æ–‡ä»¶å (å°†ä¿ç•™åŸæ‰©å±•å):</label>
                <input type="text" class="form-control" id="renameModalNewFilename" name="new_filename" required>
            </div>
            <p class="form-text text-muted">æ³¨æ„: è¯·å‹¿åŒ…å«æ‰©å±•åï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ä¿ç•™åŸå§‹æ‰©å±•åã€‚</p>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button type="button" class="btn btn-primary" id="renameModalConfirmBtn">ç¡®è®¤é‡å‘½å</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteConfirmModalLabel">ç¡®è®¤åˆ é™¤</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>æ‚¨ç¡®å®šè¦åˆ é™¤æ–‡ä»¶ <strong id="deleteConfirmFilename"></strong> å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <!-- Add ID and data attributes for JS -->
        <button type="button" class="btn btn-danger" id="deleteConfirmBtn">ç¡®è®¤åˆ é™¤</button>
      </div>
    </div>
  </div>
</div>

<!-- Rename Confirmation Modal -->
<div class="modal fade" id="renameConfirmModal" tabindex="-1" aria-labelledby="renameConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="renameConfirmModalLabel">ç¡®è®¤é‡å‘½å</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>ç¡®å®šè¦å°†æ–‡ä»¶</p>
        <p><strong id="renameConfirmOldFilename"></strong></p>
        <p>é‡å‘½åä¸º</p>
        <p><strong id="renameConfirmNewFilename"></strong> å—?</p>
        <p class="text-muted">(æ³¨æ„: å°†ä¿ç•™åŸæ‰©å±•å)</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <!-- Add ID and data attributes for JS -->
        <button type="button" class="btn btn-primary" id="renameConfirmFinalBtn">ç¡®è®¤é‡å‘½å</button>
      </div>
    </div>
  </div>
</div>

<!-- Batch Delete Confirmation Modal -->
<div class="modal fade" id="batchDeleteConfirmModal" tabindex="-1" aria-labelledby="batchDeleteConfirmModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="batchDeleteConfirmModalLabel">ç¡®è®¤æ‰¹é‡åˆ é™¤</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>ç¡®å®šè¦åˆ é™¤ä»¥ä¸‹é€‰ä¸­çš„æ–‡ä»¶å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚</p>
        <ul id="batchDeleteFileList" class="list-group list-group-sm" style="max-height: 200px; overflow-y: auto;"></ul>
        <!-- Hidden form for batch delete -->
        <form id="batchDeleteForm" action="" method="POST" style="display: none;">
            <!-- Action URL set by JS -->
            <!-- Filenames will be added here by JS -->
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
        <button type="button" class="btn btn-danger" id="confirmBatchDeleteButton">ç¡®è®¤åˆ é™¤</button>
      </div>
    </div>
  </div>
</div>

<!-- Hidden Form for Delete Actions (Single and Batch) -->
<form id="deleteImageForm" method="post" style="display: none;">
    <!-- Filenames will be added dynamically for batch delete -->
</form>

<!-- Large Image Preview Modal -->
<div class="modal fade" id="imagePreviewModal" tabindex="-1" aria-labelledby="imagePreviewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-lg-fullscreen">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header border-secondary">
        <h5 class="modal-title" id="imagePreviewModalLabel">å›¾ç‰‡é¢„è§ˆ</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0">
        <!-- Previous Button -->
        <button class="modal-nav-btn modal-nav-prev" id="previewPrevBtn" title="ä¸Šä¸€å¼  (â†)">&lt;</button>
        <!-- Image Container -->
        <img src="" alt="Large preview" id="modalPreviewImage" class="d-block mx-auto">
        <!-- Next Button -->
        <button class="modal-nav-btn modal-nav-next" id="previewNextBtn" title="ä¸‹ä¸€å¼  (â†’)">&gt;</button>
        <!-- Navigation Feedback Message -->
        <div id="previewNavFeedback" 
             class="alert alert-info position-absolute bottom-0 start-50 translate-middle-x p-2 mb-3"
             style="display: none; z-index: 1071; opacity: 0.9;" 
             role="alert">
          <!-- Message will be set by JS -->
        </div>
      </div>
      <div class="modal-footer border-secondary">
         <span id="modalPreviewFilename" class="filename-preview"></span>
         <div class="modal-actions">
              <!-- Rename Button -->
              <button type="button" id="modalRenameBtn" class="btn btn-warning" title="é‡å‘½å">âœï¸ é‡å‘½å</button>
              <!-- Delete Button -->
              <button type="button" id="modalDeleteBtn" class="btn btn-danger" title="åˆ é™¤">ğŸ—‘ï¸ åˆ é™¤</button>
         </div>
      </div>
    </div>
  </div>
</div>

<!-- Edit External Link Modal -->
<div class="modal fade" id="editExternalLinkModal" tabindex="-1" aria-labelledby="editExternalLinkModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editExternalLinkModalLabel">ç¼–è¾‘å¤–éƒ¨é“¾æ¥</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="editExternalLinkForm" method="POST"> {# Action will be set by JS #}
        <div class="modal-body">
          <input type="hidden" id="editExternalLinkId" name="link_id">
          <div class="mb-3">
            <label for="editExternalLinkUrl" class="form-label">é“¾æ¥ URL</label>
            <input type="url" class="form-control" id="editExternalLinkUrl" name="new_url" required>
          </div>
          <p class="text-muted small">å½“å‰ URL: <small id="currentExternalLinkDisplay" style="word-break: break-all;"></small></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-primary">ä¿å­˜æ›´æ”¹</button>
        </div>
      </form>
    </div>
  </div>
</div>


<!-- Bootstrap Bundle JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Embed data as JSON -->
<script id="viewData" type="application/json">
{{ {"category_name": category_name, "items": items} | tojson | safe }}
</script>

<!-- Main script -->
<script>
// Parse embedded JSON data safely
let categoryName = '';
let itemsData = []; // Changed from imagesData
let currentPreviewIndex = -1; // Used for local image preview navigation

try {
    const viewDataElement = document.getElementById('viewData');
    if (viewDataElement && viewDataElement.textContent) {
        const embeddedData = JSON.parse(viewDataElement.textContent);
        categoryName = embeddedData.category_name;
        itemsData = embeddedData.items; // Changed from images
        console.log('Successfully parsed embedded data:', categoryName, itemsData);
    } else {
        console.error('Could not find or parse viewData script tag.');
    }
} catch (e) {
    console.error('Error parsing embedded JSON data:', e);
    // Handle error gracefully, maybe disable features
}

// --- Modal References --- 
const imagePreviewModalElement = document.getElementById('imagePreviewModal');
const imagePreviewModal = new bootstrap.Modal(imagePreviewModalElement);
const modalImage = document.getElementById('modalPreviewImage');
const modalFilenameSpan = document.getElementById('modalPreviewFilename');
const modalRenameBtn = document.getElementById('modalRenameBtn');
const modalDeleteBtn = document.getElementById('modalDeleteBtn');
const previewPrevBtn = document.getElementById('previewPrevBtn');
const previewNextBtn = document.getElementById('previewNextBtn');

// --- Rename Modal References --- 
const renameModalElementRef = document.getElementById('renameModal');
const renameModalRef = new bootstrap.Modal(renameModalElementRef);
const renameModalOldFilenameSpanRef = document.getElementById('renameModalOldFilename');
const renameModalNewFilenameInputRef = document.getElementById('renameModalNewFilename');
const renameModalCategoryInputRef = document.getElementById('renameModalCategoryName');
const renameModalOldHiddenInputRef = document.getElementById('renameModalOldFilenameHidden');
const renameConfirmBtnRef = document.getElementById('renameModalConfirmBtn');

// --- Rename Confirmation Modal References --- 
const renameConfirmModalElement = document.getElementById('renameConfirmModal');
const renameConfirmModal = new bootstrap.Modal(renameConfirmModalElement);
const renameConfirmOldFilenameSpan = document.getElementById('renameConfirmOldFilename');
const renameConfirmNewFilenameSpan = document.getElementById('renameConfirmNewFilename');
const renameConfirmFinalBtn = document.getElementById('renameConfirmFinalBtn');

// --- Delete Confirmation Modal References --- 
const deleteConfirmModalElement = document.getElementById('deleteConfirmModal');
const deleteConfirmModal = new bootstrap.Modal(deleteConfirmModalElement);
const deleteConfirmFilenameSpan = document.getElementById('deleteConfirmFilename');
const deleteConfirmBtn = document.getElementById('deleteConfirmBtn');

// --- Hidden Delete Form ---
const deleteFormRef = document.getElementById('deleteImageForm');

const previewNavFeedback = document.getElementById('previewNavFeedback');
let feedbackTimeout = null;

// --- Function to Update Preview Modal Content (Unified for all item types) ---
function updatePreviewModal(index) {
    if (!itemsData || index < 0 || index >= itemsData.length) {
        console.error('Invalid index for item preview:', index, itemsData);
        imagePreviewModal.hide(); // Hide modal if index is invalid
        return;
    }
    currentPreviewIndex = index; // This index is relative to the full itemsData
    const itemData = itemsData[index];

    console.log(`Updating preview to item index ${index}: ${itemData.name} (Type: ${itemData.type})`);

    modalImage.src = itemData.view_url;
    modalImage.alt = itemData.name; // Use item.name (filename or URL)
    modalFilenameSpan.textContent = itemData.name;
    modalFilenameSpan.title = itemData.name;

    // Configure modal actions based on item type
    if (itemData.type === 'local') {
        modalRenameBtn.style.display = 'inline-block';
        modalRenameBtn.dataset.oldFilename = itemData.name; // Original filename for rename
        
        modalDeleteBtn.style.display = 'inline-block';
        modalDeleteBtn.dataset.itemType = 'local';
        modalDeleteBtn.dataset.itemId = itemData.id; // This is filename for local
        modalDeleteBtn.dataset.itemName = itemData.name; // For confirmation message
    } else if (itemData.type === 'external') {
        modalRenameBtn.style.display = 'none'; // No rename for external links

        modalDeleteBtn.style.display = 'inline-block';
        modalDeleteBtn.dataset.itemType = 'external';
        modalDeleteBtn.dataset.itemId = itemData.id; // This is UUID for external
        modalDeleteBtn.dataset.itemName = itemData.name; // URL for confirmation
    } else {
        // Should not happen, but hide actions if unknown type
        modalRenameBtn.style.display = 'none';
        modalDeleteBtn.style.display = 'none';
    }
    // Navigation buttons are handled by their own click/keydown listeners based on currentPreviewIndex and itemsData.length
}

// --- Function to Show Navigation Feedback ---
function showNavFeedback(message) {
    if (feedbackTimeout) {
        clearTimeout(feedbackTimeout);
    }
    previewNavFeedback.textContent = message;
    previewNavFeedback.style.display = 'block';
    feedbackTimeout = setTimeout(() => {
        previewNavFeedback.style.display = 'none';
    }, 1500); // Show for 1.5 seconds
}

// --- Event Listeners ---

// Unified Thumbnail clicks for all item types
document.querySelectorAll('.image-card').forEach(card => {
    card.addEventListener('click', function(event) {
        if (document.body.classList.contains('batch-mode')) {
            // In batch mode, card click is for selection, handled by another listener (around line 1067)
            // We ensure this click doesn't bubble up or trigger preview if it's on the card itself.
            // The selection logic should ideally prevent preview.
            // If an action button inside the card was somehow visible and clicked, we'd ignore that too.
            if (event.target.closest('.actions')) return; // Should be hidden in batch mode anyway
            // The selection logic is primary here.
            return;
        }

        // --- START MODIFICATION for sub-link ---
        // Check if the actual click target was the "å°è¯•æ‰“å¼€åŸå§‹é“¾æ¥" sub-link
        // The sub-link has classes: 'btn', 'btn-sm', 'btn-link', 'p-0'
        const clickedSubLink = event.target.closest('a.btn.btn-link');
        // Also check if the main image for this card has indeed failed (is hidden)
        // This ensures we only bypass modal for the error-case sub-link.
        const mainImageInCard = this.querySelector('img.img-thumbnail');

        if (clickedSubLink && mainImageInCard && mainImageInCard.style.display === 'none') {
            // Click was on the "å°è¯•æ‰“å¼€åŸå§‹é“¾æ¥" for a failed image.
            // Allow the link's default action (open in new tab). Do not open preview modal.
            // console.log('Clicked on "å°è¯•æ‰“å¼€åŸå§‹é“¾æ¥", allowing default action.');
            return;
        }
        // --- END MODIFICATION for sub-link ---

        // Not in batch mode, and not the error sub-link, proceed to show preview modal
        const itemId = this.dataset.itemId;
        const itemType = this.dataset.itemType;

        // Find the index of the clicked item in the global itemsData array
        const itemIndex = itemsData.findIndex(item => item.id === itemId && item.type === itemType);

        if (itemIndex !== -1) {
            // If the click was on an external link's <a> tag or its child img, let the default browser action (open link) happen.
            // But also open our modal if it's not a direct click on the <a> tag itself for opening in new tab.
            // For external items, the image is wrapped in an <a> tag.
            // We want to open the modal unless the user explicitly middle-clicked or ctrl-clicked the link.
            
            let openModal = true;
            if (itemType === 'external') {
                // If the click target is the <a> tag itself or its direct child (the image),
                // and it's a simple left click (not modified), we might want to show modal.
                // If it's a modified click (Ctrl, Shift, Meta, Middle button), browser handles new tab.
                if (event.target.closest('a[target="_blank"]') && (event.ctrlKey || event.metaKey || event.shiftKey || event.button === 1) ) {
                    openModal = false; // Let browser handle new tab opening
                }
            }
            
            if (openModal) {
                event.preventDefault(); // Prevent default action if we are opening the modal (e.g. for external link's <a> tag)
                console.log(`Item card clicked (non-batch): ID ${itemId}, Type ${itemType}, Mapped index ${itemIndex}`);
                updatePreviewModal(itemIndex);
                imagePreviewModal.show();
            }
        } else {
            console.error(`Could not find clicked item (ID: ${itemId}, Type: ${itemType}) in itemsData for preview.`);
        }
    });
});

// Modal navigation buttons (Unified for all itemsData)
previewPrevBtn.addEventListener('click', () => {
    if (!itemsData.length) return;
    if (currentPreviewIndex > 0) {
        updatePreviewModal(currentPreviewIndex - 1);
    } else {
        showNavFeedback('å·²ç»æ˜¯ç¬¬ä¸€å¼ äº†');
    }
});

previewNextBtn.addEventListener('click', () => {
    if (!itemsData.length) return;
    if (currentPreviewIndex < itemsData.length - 1) {
        updatePreviewModal(currentPreviewIndex + 1);
    } else {
         showNavFeedback('å·²ç»æ˜¯æœ€åä¸€å¼ äº†');
    }
});

// Modal action buttons
modalRenameBtn.addEventListener('click', function() {
    const oldFilename = this.dataset.oldFilename;
    if (!oldFilename) return;
    console.log(`Modal Rename button clicked for: ${categoryName}/${oldFilename}`);
    
    // Populate the rename modal
    renameModalOldFilenameSpanRef.textContent = oldFilename;
    renameModalCategoryInputRef.value = categoryName;
    renameModalOldHiddenInputRef.value = oldFilename;
    renameModalNewFilenameInputRef.value = oldFilename;
    
    renameModalRef.show();
    renameModalNewFilenameInputRef.focus();
});

modalDeleteBtn.addEventListener('click', function() {
    const itemId = this.dataset.itemId;
    const itemType = this.dataset.itemType;
    const itemName = this.dataset.itemName; // For confirmation message

    if (!itemId || !itemType) {
        console.error("Missing item ID or type for modal delete.");
        return;
    }

    if (itemType === 'local') {
        // Populate delete confirm modal for local file
        deleteConfirmFilenameSpan.textContent = itemName; // itemName is filename for local
        // Store necessary data on the confirm button for local file deletion
        deleteConfirmBtn.dataset.categoryName = categoryName;
        deleteConfirmBtn.dataset.filename = itemId; // itemId is filename for local
        deleteConfirmBtn.dataset.itemType = 'local'; // Explicitly set type
        deleteConfirmModal.show();
    } else if (itemType === 'external') {
        // For external links, directly confirm and then POST to delete_external_link endpoint
        if (confirm(`ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¤–éƒ¨é“¾æ¥å—ï¼Ÿ\n${itemName}`)) {
            const deleteUrl = `/admin/category/${encodeURIComponent(categoryName)}/external_link/${encodeURIComponent(itemId)}/delete`;
            // Use a temporary form to POST, similar to how individual external link delete works
            const tempForm = document.createElement('form');
            tempForm.method = 'post';
            tempForm.action = deleteUrl;
            tempForm.style.display = 'none';
            document.body.appendChild(tempForm);
            tempForm.submit(); // This will cause a page reload
        }
    }
});

// Keyboard navigation
imagePreviewModalElement.addEventListener('shown.bs.modal', () => {
    console.log('Preview modal shown, adding keydown listener');
    document.addEventListener('keydown', handleModalKeydown);
});

imagePreviewModalElement.addEventListener('hidden.bs.modal', () => {
    console.log('Preview modal hidden, removing keydown listener');
    document.removeEventListener('keydown', handleModalKeydown);
});

function handleModalKeydown(event) {
    if (!itemsData.length) return; // No items to navigate

    if (event.key === 'ArrowLeft') {
        event.preventDefault();
        if (currentPreviewIndex > 0) {
            updatePreviewModal(currentPreviewIndex - 1);
        } else {
            showNavFeedback('å·²ç»æ˜¯ç¬¬ä¸€å¼ äº†');
        }
    } else if (event.key === 'ArrowRight') {
        event.preventDefault();
        if (currentPreviewIndex < itemsData.length - 1) {
            updatePreviewModal(currentPreviewIndex + 1);
        } else {
            showNavFeedback('å·²ç»æ˜¯æœ€åä¸€å¼ äº†');
        }
    }
}

// Rename Input Modal -> Confirm Button Click -> Opens Rename Confirm Modal OR Closes if Unchanged
renameConfirmBtnRef.addEventListener('click', function() {
    const category = renameModalCategoryInputRef.value;
    const oldFilename = renameModalOldHiddenInputRef.value;
    const newFilenameRaw = renameModalNewFilenameInputRef.value.trim();

    if (!newFilenameRaw) { alert('æ–°æ–‡ä»¶åä¸èƒ½ä¸ºç©ºï¼'); return; } 
    
    // If filename is unchanged, just hide the modal like cancel was clicked.
    if (newFilenameRaw === oldFilename) {
        renameModalRef.hide(); // Hide the modal
        return; // Exit
    }
    
    // --- Logic for actual rename confirmation --- 
    renameConfirmOldFilenameSpan.textContent = oldFilename;
    renameConfirmNewFilenameSpan.textContent = newFilenameRaw;
    renameConfirmFinalBtn.dataset.categoryName = category;
    renameConfirmFinalBtn.dataset.oldFilename = oldFilename;
    renameConfirmFinalBtn.dataset.newFilenameRaw = newFilenameRaw;
    
    renameModalRef.hide(); 
    renameConfirmModal.show(); 
});

// --- Auto-hide Flash Messages --- 
document.addEventListener('DOMContentLoaded', (event) => { 
    const flashMessages = document.querySelectorAll('#flash-message-container .alert');
    flashMessages.forEach(flashMessage => {
        setTimeout(() => {
            const alertInstance = bootstrap.Alert.getOrCreateInstance(flashMessage);
            if (alertInstance) { alertInstance.close(); } else { flashMessage.remove(); }
        }, 5000);
    });
});

// --- Helper Functions --- 
function formatBytes(bytes, decimals = 2) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const dm = decimals < 0 ? 0 : decimals;
    const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
}
function escapeHtml(unsafe) {
    return unsafe
         .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
         .replace(/"/g, "&quot;").replace(/'/g, "&#039;");
}
function truncateUrl(url, maxLength = 60) {
    if (url.length <= maxLength) {
        return url;
    }
    const startLength = Math.floor(maxLength * 0.7);
    const endLength = maxLength - startLength - 3; 
    return url.substring(0, startLength) + '...' + url.substring(url.length - endLength);
}

// --- Image Card Action Buttons --- 

// Card Rename Button Click -> Opens Rename Input Modal (Unchanged)
document.querySelectorAll('.rename-btn').forEach(button => {
    button.addEventListener('click', function() {
        const categoryName = this.dataset.categoryName;
        const oldFilename = this.dataset.oldFilename;
        console.log(`Card Rename button clicked for: ${categoryName}/${oldFilename}`);
        // Populate the rename input modal
        renameModalOldFilenameSpanRef.textContent = oldFilename;
        renameModalCategoryInputRef.value = categoryName;
        renameModalOldHiddenInputRef.value = oldFilename;
        renameModalNewFilenameInputRef.value = oldFilename;
        // Modal is shown via data-bs-toggle/target
        // We might need a slight delay for focus if modal isn't shown yet
        setTimeout(() => renameModalNewFilenameInputRef.focus(), 150); 
    });
});

// Card Delete Button Click -> Opens Delete Confirm Modal
document.querySelectorAll('.delete-btn').forEach(button => {
    button.addEventListener('click', function() {
        const categoryName = this.dataset.categoryName;
        const filename = this.dataset.filename;
        if (!categoryName || !filename) return;
        // Populate delete confirm modal
        deleteConfirmFilenameSpan.textContent = filename;
        // Store necessary data on the confirm button
        deleteConfirmBtn.dataset.categoryName = categoryName;
        deleteConfirmBtn.dataset.filename = filename;
        // Show delete confirm modal
        deleteConfirmModal.show();
    });
});

// --- Confirmation Modal Button Listeners ---

// Delete Confirmation Modal -> Confirm Button Click (Now only for local files from modal)
deleteConfirmBtn.addEventListener('click', function() {
    const itemType = this.dataset.itemType;
    if (itemType !== 'local') { // This button in this modal is now only for local
        console.warn("Delete confirm button in modal clicked for non-local item. This shouldn't happen.");
        deleteConfirmModal.hide();
        return;
    }

    const category = this.dataset.categoryName;
    const filename = this.dataset.filename; // This is the item.id for local files

    if (!category || !filename) {
        console.error('Missing data on delete confirm button for local file!');
        return;
    }
    console.log(`Delete Confirmed (Modal) for local file ${category}/${filename}`);
    const actionUrl = `/admin/delete_image/${encodeURIComponent(category)}/${encodeURIComponent(filename)}`;
    
    // Use the existing deleteFormRef if it's still intended for single local file deletes
    // or create a new temp form. For consistency with rename, let's use a temp form.
    const tempForm = document.createElement('form');
    tempForm.method = 'post';
    tempForm.action = actionUrl;
    tempForm.style.display = 'none';
    document.body.appendChild(tempForm);
    tempForm.submit();
    // No need to hide, page will refresh
});

// Rename Confirmation Modal -> Final Confirm Button Click
renameConfirmFinalBtn.addEventListener('click', function() {
    const category = this.dataset.categoryName;
    const oldFilename = this.dataset.oldFilename;
    const newFilenameRaw = this.dataset.newFilenameRaw;

    if (!category || !oldFilename || !newFilenameRaw) {
        console.error('Missing data on rename final confirm button!');
        return;
    }

    console.log(`Rename Confirmed (Final Modal) for ${category}/${oldFilename} to ${newFilenameRaw}`);
    const actionUrl = `/admin/rename/${encodeURIComponent(category)}/${encodeURIComponent(oldFilename)}`;
    const tempForm = document.createElement('form');
    tempForm.method = 'post';
    tempForm.action = actionUrl;
    tempForm.style.display = 'none';
    const newFilenameInput = document.createElement('input');
    newFilenameInput.type = 'hidden';
    newFilenameInput.name = 'new_filename';
    newFilenameInput.value = newFilenameRaw;
    tempForm.appendChild(newFilenameInput);
    document.body.appendChild(tempForm);
    tempForm.submit();
    // No need to hide, page will refresh
});

// --- Refined Confirmation Modal Z-index Handling ---
// Listen for when confirmation modals are about to be shown
[renameModalElementRef, deleteConfirmModalElement, renameConfirmModalElement].forEach(modalElem => {
    if (modalElem) { // Ensure element exists
        modalElem.addEventListener('show.bs.modal', function (event) {
            // Check if the preview modal is currently shown
            if (imagePreviewModalElement.classList.contains('show')) {
                 // Set a fixed high z-index only when needed
                 console.log(`Setting z-index for ${modalElem.id} because preview modal is open.`);
                 modalElem.style.zIndex = '1060'; 
            }
        });

        // Listen for when confirmation modals are hidden
        modalElem.addEventListener('hidden.bs.modal', function(event) {
           // Reset z-index when the modal is closed
           console.log(`Resetting z-index for ${modalElem.id}.`);
           modalElem.style.zIndex = ''; 
        });
    }
});

// --- Handle Per Page Change --- 
const perPageSelect = document.getElementById('perPageSelect');
if (perPageSelect) {
    perPageSelect.addEventListener('change', function() {
        const newPerPage = this.value;
        const currentUrl = new URL(window.location.href);
        // Reset page to 1 when changing items per page
        currentUrl.searchParams.set('page', '1'); 
        currentUrl.searchParams.set('per_page', newPerPage);
        window.location.href = currentUrl.toString();
    });
}

// --- Filter Category Dropdown ---
const categoryFilterInput = document.getElementById('categoryFilterInput');
const categoryDropdownMenu = document.getElementById('categoryDropdownMenu');

if (categoryFilterInput && categoryDropdownMenu) {
    const categoryItems = categoryDropdownMenu.querySelectorAll('li > a.dropdown-item'); // Select only actual links

    // Prevent dropdown from closing when clicking input
    categoryFilterInput.addEventListener('click', function(e) {
        e.stopPropagation();
    });

    categoryFilterInput.addEventListener('input', function() {
        const filterText = this.value.trim().toLowerCase();
        
        categoryItems.forEach(item => {
            const categoryText = item.textContent.toLowerCase();
            const listItem = item.parentElement; // Get the <li> element

            if (categoryText.includes(filterText)) {
                listItem.style.display = ''; // Show
            } else {
                listItem.style.display = 'none'; // Hide
            }
        });
    });
}

// --- Batch Mode State & Toggle ---
const toggleBatchModeButton = document.getElementById('toggleBatchMode');
const selectAllCheckbox = document.getElementById('selectAllCheckbox');
const batchDeleteModalElement = document.getElementById('batchDeleteConfirmModal');
const batchDeleteFileList = document.getElementById('batchDeleteFileList');
const batchDeleteForm = document.getElementById('batchDeleteForm');
const confirmBatchDeleteButton = document.getElementById('confirmBatchDeleteButton');
// Get containers for moving the button
const viewBatchControls = document.querySelector('.view-batch-controls'); 
const viewNormalControls = document.querySelector('.view-normal-controls');


if (toggleBatchModeButton && viewBatchControls && viewNormalControls) { // Check all elements exist
    toggleBatchModeButton.addEventListener('click', function() {
        const isEnteringBatchMode = !document.body.classList.contains('batch-mode');
        document.body.classList.toggle('batch-mode');

        if (isEnteringBatchMode) {
            // --- Entering Batch Mode ---
            this.textContent = 'é€€å‡ºç®¡ç†';
            this.classList.remove('btn-info');
            this.classList.add('btn-secondary');
            // Move button to batch controls
            viewBatchControls.appendChild(this);

        } else {
            // --- Exiting Batch Mode ---
            this.textContent = 'æ‰¹é‡ç®¡ç†';
            this.classList.remove('btn-secondary');
            this.classList.add('btn-info');
            // Move button back to normal controls
            viewNormalControls.appendChild(this);

            // Reset selections when exiting batch mode
            document.querySelectorAll('.image-card.is-selected').forEach(card => {
                card.classList.remove('is-selected');
            });
            if (selectAllCheckbox) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            }
            updateSelectAllState(); // Ensure visual state reset
        }
    });
} else {
    console.error('Required elements for batch mode toggle not found!');
}

// --- Selection Logic ---

// Clicking the card toggles selection in batch mode
document.querySelectorAll('.image-wall .image-card').forEach(card => {
    const image = card.querySelector('img.preview-trigger'); // Target preview image

    card.addEventListener('click', function(event) {
        // Only act if in batch mode
        if (document.body.classList.contains('batch-mode')) { 
            // Prevent toggling if clicking an action button (though actions are hidden in batch mode by CSS)
            if (!event.target.closest('.actions')) {
                this.classList.toggle('is-selected');
                updateSelectAllState(); // Update select all checkbox state
            }
            // IMPORTANT: Prevent modal from showing in batch mode
            return; 
        }
        
        // Non-batch mode clicks are handled by the .preview-trigger listener now.
    });
});

// Select All / Deselect All
if(selectAllCheckbox) {
    selectAllCheckbox.addEventListener('change', function() {
        const isChecked = this.checked;
        document.querySelectorAll('.image-wall .image-card').forEach(card => {
            // Add or remove 'is-selected' based on the 'Select All' checkbox state
            card.classList.toggle('is-selected', isChecked);
        });
        updateSelectAllState(); // Need to update state after toggling all
    });
} 

// Helper to update select-all checkbox state
function updateSelectAllState() {
    if(!selectAllCheckbox) return;
    const allCards = document.querySelectorAll('.image-wall .image-card');
    const selectedCards = document.querySelectorAll('.image-wall .image-card.is-selected');
    const totalCount = allCards.length;
    const selectedCount = selectedCards.length;

    if (totalCount > 0 && totalCount === selectedCount) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
    } else if (selectedCount > 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true; // Partially selected
    } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    }
}

// --- Batch Delete Modal Preparation & Submission ---

if (batchDeleteModalElement) {
    batchDeleteModalElement.addEventListener('show.bs.modal', function (event) {
        const selectedItems = getSelectedItems(); // Use the unified function
        batchDeleteFileList.innerHTML = ''; // Clear previous list
        // batchDeleteForm.innerHTML = ''; // No longer using batchDeleteForm for submission

        if (selectedItems.length === 0) {
             alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªé¡¹ç›®è¿›è¡Œåˆ é™¤ã€‚'); // Updated alert message
             event.preventDefault(); // Prevent modal from opening
             return;
        }

        // No longer setting batchDeleteForm.action

        selectedItems.forEach(item => {
            // Populate list in modal body
            const li = document.createElement('li');
            li.className = 'list-group-item list-group-item-sm';
            li.textContent = item.name; // Display item.name (filename or URL)
            batchDeleteFileList.appendChild(li);
            // No longer creating hidden input fields for a form
        });
        
        // Reset confirm button state
         if(confirmBatchDeleteButton) {
             confirmBatchDeleteButton.disabled = false;
             confirmBatchDeleteButton.textContent = 'ç¡®è®¤åˆ é™¤';
         }
    });
} else {
    console.error("Batch Delete Modal element not found!");
}

// Handle confirm batch delete button click
if (confirmBatchDeleteButton) {
    confirmBatchDeleteButton.addEventListener('click', () => {
        const selectedItems = getSelectedItems();
        if (selectedItems.length === 0) {
            alert('æ²¡æœ‰é€‰ä¸­ä»»ä½•é¡¹ç›®ã€‚');
            const modalInstance = bootstrap.Modal.getInstance(batchDeleteModalElement);
            if(modalInstance) modalInstance.hide();
            return;
        }

        confirmBatchDeleteButton.disabled = true;
        confirmBatchDeleteButton.textContent = 'åˆ é™¤ä¸­...';

        const payload = {
            items_to_delete: selectedItems
        };

        fetch(`/admin/batch_delete_items/${encodeURIComponent(categoryName)}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                // Add CSRF token header if your app uses them
            },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            console.log('Batch delete response:', data);
            // Display detailed results in the modal or as flash messages
            // For now, just a general message and reload
            let successCount = 0;
            let errorCount = 0;
            if (data.results) {
                data.results.forEach(result => {
                    if (result.status === 'success') {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                });
            }

            if (errorCount === 0 && successCount > 0) {
                createFlashMessage(`æˆåŠŸåˆ é™¤ ${successCount} ä¸ªé¡¹ç›®ã€‚`, 'success');
            } else if (successCount > 0 && errorCount > 0) {
                createFlashMessage(`éƒ¨åˆ†é¡¹ç›®åˆ é™¤æˆåŠŸ (${successCount} ä¸ª)ï¼Œéƒ¨åˆ†å¤±è´¥ (${errorCount} ä¸ª)ã€‚è¯¦æƒ…è¯·æŸ¥çœ‹æ§åˆ¶å°ã€‚`, 'warning');
            } else if (errorCount > 0 && successCount === 0) {
                createFlashMessage(`æ‰€æœ‰é€‰ä¸­çš„ ${errorCount} ä¸ªé¡¹ç›®åˆ é™¤å¤±è´¥ã€‚è¯¦æƒ…è¯·æŸ¥çœ‹æ§åˆ¶å°ã€‚`, 'danger');
            } else {
                 createFlashMessage('æœªæ‰§è¡Œä»»ä½•åˆ é™¤æ“ä½œæˆ–æœªçŸ¥é”™è¯¯ã€‚', 'info');
            }
            
            // Reload after a short delay to allow flash message to be seen if it's immediately replaced
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        })
        .catch(error => {
            console.error('Error during batch delete:', error);
            createFlashMessage('æ‰¹é‡åˆ é™¤æ—¶å‘ç”Ÿç½‘ç»œæˆ–æœåŠ¡å™¨é”™è¯¯ã€‚', 'danger');
            confirmBatchDeleteButton.disabled = false;
            confirmBatchDeleteButton.textContent = 'ç¡®è®¤åˆ é™¤';
        });
    });
} else {
     console.error("Confirm Batch Delete button not found!");
}

// Helper function to get selected items (ID, Type, Name)
function getSelectedItems() {
    return Array.from(document.querySelectorAll('.image-wall .image-card.is-selected')).map(card => {
        return {
            id: card.dataset.itemId,
            type: card.dataset.itemType,
            name: card.dataset.itemName // Useful for display in confirmation
        };
    });
}

// --- Edit External Link Modal Handling ---
const editExternalLinkModalElement = document.getElementById('editExternalLinkModal');
const editExternalLinkForm = document.getElementById('editExternalLinkForm');
const editExternalLinkIdInput = document.getElementById('editExternalLinkId');
const editExternalLinkUrlInput = document.getElementById('editExternalLinkUrl');
const currentExternalLinkDisplay = document.getElementById('currentExternalLinkDisplay');

if (editExternalLinkModalElement) {
    editExternalLinkModalElement.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget; // Button that triggered the modal
        const linkId = button.dataset.linkId;
        const linkUrl = button.dataset.linkUrl;

        editExternalLinkIdInput.value = linkId;
        editExternalLinkUrlInput.value = linkUrl;
        currentExternalLinkDisplay.textContent = linkUrl;
        
        // Set form action dynamically
        editExternalLinkForm.action = `/admin/category/${encodeURIComponent(categoryName)}/external_link/${encodeURIComponent(linkId)}/edit`;
    });
}

if (editExternalLinkForm) {
    editExternalLinkForm.addEventListener('submit', function(event) {
        // Basic validation, more robust validation on backend
        if (!editExternalLinkUrlInput.value.trim()) {
            event.preventDefault();
            alert('URL ä¸èƒ½ä¸ºç©ºã€‚');
            // Optionally, re-focus or add more specific error display
        }
        // Submission will proceed as a normal form POST if not prevented
    });
}

// The block starting at line 1117 now handles the unified logic.
// This redundant block for batchDeleteModalElement 'show.bs.modal' (previously around 1228) is removed by the change above.
// Ensure createFlashMessage function is available or implemented
function createFlashMessage(message, category) {
    const container = document.getElementById('flash-message-container');
    if (!container) {
        console.error('Flash message container not found!');
        alert(`${category.toUpperCase()}: ${message}`); // Fallback
        return;
    }

    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${category} alert-dismissible fade show`;
    alertDiv.setAttribute('role', 'alert');
    alertDiv.innerHTML = `
        ${escapeHtml(message)}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    container.appendChild(alertDiv);

    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        const alertInstance = bootstrap.Alert.getOrCreateInstance(alertDiv);
        if (alertInstance) {
            alertInstance.close();
        } else {
            alertDiv.remove(); // Fallback if instance not found (e.g., during rapid reloads)
        }
    }, 5000);
}

</script>

</body>
</html>